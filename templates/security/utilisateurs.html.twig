{% extends "base.html.twig" %}
{% block title %}
    adminsistration Utilisateur
{% endblock title %}
 {% block body %}

<h2>UTILISATEURS</h2>



<table id="grid-data" class="table table-condensed table-hover table-striped">
    <thead>
        <tr>
            <th data-column-id="id" data-visible="false" data-sortable="false">Id</th>
            <th data-column-id="username">Nom d'utilisateur</th>
            <th data-column-id="roles" >Nom</th>
            <th data-column-id="roles" >Premon</th>
            <th data-column-id="commands" data-formatter="commands" data-sortable="false">Action</th>
        </tr>
    </thead>
    <tbody>
        {% for utilisateur in utilisateurs %}
        <tr>
            <td>{{ utilisateur.id }}</td>
            <td>{{ utilisateur.username }}</td>
            <td>{{utilisateur.nom}}</td>
            <td>{{utilisateur.premon}}</td>   
            <td>

            </td>         
        </tr>
    {% else %}
        <tr>
            <td colspan="4">no records found</td>
        </tr>
    {% endfor %}
    </tbody>
</table>
{{ dump(form_creation) }}
<div class="row">
    <div class="col-md-6">
        <fieldset class="well">
            <legend class="well-legend">Créer un utilisateur</legend>
            {{ form_start(form_creation) }}
            {{ form_row(form_creation.Username) }}
            {{ form_row(form_creation.nom) }}
            {{ form_row(form_creation.premon) }}
            {{ form_row(form_creation.plainPassword) }}
            {{form_row(form_creation._token)}}
            <button name="creation" class="button btn" type="submit">Créer</button>
            {{ form_row(form_creation._token) }}
            {{ form_end(form_creation, {'render_rest' : false}) }}
        </fieldset>
    </div>
    <div class="col-md-6">
        <fieldset class="well">
            <legend class="well-legend">Modifier un utilisateur</legend>

            {{ form_start(form_modif) }}
            {{ form_row(form_modif.username, {'attr': {'autocomplete': 'off'}}) }}
            {{ form_row(form_modif.email) }}
            {{ form_row(form_modif.id_user) }}
            {{ form_widget(form_modif.plainPassword, {'required' : false, 'attr': {'autocomplete': 'off'}}) }}
            {{ form_row(form_modif.roles, {"attr": {"class" : "basic-multiple-role"}}) }}
            <button name="modif" class="button btn" type="submit">Modifier</button>
            {{ form_end(form_modif) }}
        </fieldset>
    </div>
</div>

{% endblock %}

{% block javascript %}
    <script type="text/javascript">


        var grid = $("#grid-data").bootgrid({
            ajax: true,
            requestHandler: function (request) {
                request.id = "b0df282a-0d67-40e5-8558-c9e93b7befed";
                request.currentPage = $("#grid-data").bootgrid("getCurrentPage");
                request.rowCount = $("#grid-data").bootgrid("getRowCount");
                return request;
            },
            url: "{{ path('admin') }}",
            formatters: {
                "commands": function (column, row) {
                    return "<button type=\"button\" class=\"btn btn-xs btn-default command-edit\" data-row-id=\"" + row.id + "\"><span class=\"fa fa-pencil\"></span></button> " + "<button type=\"button\" class=\"btn btn-xs btn-default command-delete\" data-row-id=\"" + row.id + "\"><span class=\"fa fa-trash-o\"></span></button>";
                }
            }
        }).on("loaded.rs.jquery.bootgrid", function () {
            /* Executes after data is loaded and rendered */
            grid.find(".command-edit").on("click", function (e) {
                var id = $(this).attr("data-row-id");
                $.ajax({
                    url: "{{ path('utilisateurs_index_modif') }}",
                    type: "POST",
                    dataType: "json",
                    data: {
                        'id': id
                    },
                    async: true,
                    success: function (resp) {
                        var user = JSON.parse(resp);
                        $("#form_id_user").val(user.id);
                        $("#form_username").val(user.username);
                        $("#form_nom").val(user.nom);
                        $("#form_plainPassword").val('');
                        $("#form_roles").val(user.roles);
                        $("#form_roles").trigger('change');
                    }
                });
            }).end().find(".command-delete").on("click", function (e) {
                var url = "{{ path('utilisateurs_remove', {'id': 'utilisateur-id'}) }}";
                var id = $(this).attr("data-row-id");
                url = url.replace('utilisateur-id', id)
                $('#deleteForm').attr('action', url);
                $('#confirm-submit').modal();
            });
        });

        // form creation
        $('button[name=creation]').on('click', function (e) {
            $('form[name=utilisateurs]').submit(function () {
                e.preventDefault();
                $("#utilisateurs_plainPassword_first").removeClass('is-invalid');
                $("#regex").remove();
                $("#len").remove();

                var regex = /^(?=.*\d)(?=.*[a-z])(?=.*[A-Z])(?=.*\W)(?!.*\s).*$/;
                var pass = $('#utilisateurs_plainPassword_first').val();
                if (!regex.test(pass)) {

                    var msg = '<span id="regex" class="invalid-feedback d-block"><span class="mb-0 d-block"><span class="initialism form-error-icon badge badge-danger">Erreur</span><span class="form-error-message">Doit contenir une majuscule, une minuscule, un chiffre et un symbole.</span></span></span>';
                    $("#utilisateurs_plainPassword_first").addClass('is-invalid').after(msg);
                    disableCreer();
                    return false;
                } else if (pass.length < 8) {

                    var msg = '<span id="len" class="invalid-feedback d-block"><span class="mb-0 d-block"><span class="initialism form-error-icon badge badge-danger">Erreur</span><span class="form-error-message">Doit contenir au moins 8 caractères.</span></span></span>';
                    $("#utilisateurs_plainPassword_first").addClass('is-invalid').after(msg);
                    disableCreer();
                    return false;
                }

                $.ajax({
                    type: "POST",
                    data: {
                        user: $(this).serializeArray()
                    },
                    url: "{{ path('utilisateurs_index_create') }}",
                    success: function () {
                        $('form[name="utilisateurs"]')[0].reset();
                        $("#grid-data").bootgrid('reload');
                    }
                });
                return false;
            });
        });

        function disableCreer() {
            $('button[name="creation"]').attr("disabled", true);

        }

        function enableCreer() {
            $('button[name="creation"]').prop("disabled", false);
        }

        function disableModifier() {
            $('button[name="modif"]').attr("disabled", true);

        }

        function enableModifier() {
            $('button[name="modif"]').prop("disabled", false);
        }

        // username_error
        $("#utilisateurs_username").change(function () {
            $(this).parent().find('input, select').removeClass('is-invalid');
            $(this).parent().find(".invalid-feedback").remove();
            var username = $(this).val();
            $.ajax({
                url: "{{ path( 'utilisateurs_username_error' ) }}",
                type: "POST",
                dataType: "json",
                data: {
                    "username": username
                },
                success: function (resp) {
                    if (resp) {
                        var msg = '<span class="invalid-feedback d-block"><span class="mb-0 d-block"><span class="initialism form-error-icon badge badge-danger">Erreur</span><span class="form-error-message">Ce username est déjà attribué.</span></span></span>';
                        $("#utilisateurs_username").addClass('is-invalid').after(msg);
                        disableCreer();

                    } else {
                        if (username) {
                            enableCreer();
                        }
                    }
                }
            });
        });

        // email_error
        $("#utilisateurs_email").change(function () {
            $(this).parent().find('input, select').removeClass('is-invalid');
            $(this).parent().find(".invalid-feedback").remove();
            var email = $(this).val();
            $.ajax({
                url: "{{ path( 'utilisateurs_email_error' ) }}",
                type: "POST",
                dataType: "json",
                data: {
                    "email": email
                },
                success: function (resp) {
                    if (resp) {
                        var msg = '<span class="invalid-feedback d-block"><span class="mb-0 d-block"><span class="initialism form-error-icon badge badge-danger">Erreur</span><span class="form-error-message">Cet email est déjà attribué.</span></span></span>';
                        $("#utilisateurs_email").addClass('is-invalid').after(msg);
                        disableCreer();

                    } else {
                        if (email) {
                            enableCreer();
                        }
                    }
                }
            });
        });

        // password_error
        $("#utilisateurs_plainPassword_second").keyup(function () {
            $("#utilisateurs_plainPassword_first").parent().find('input, select').removeClass('is-invalid');
            $("#utilisateurs_plainPassword_first").parent().find(".invalid-feedback").remove();
            var password_second = $(this).val();

            var password_first = $("#utilisateurs_plainPassword_first").val();

            if (password_first && password_second && (password_first != password_second)) {
                var msg = '<span class="invalid-feedback d-block"><span class="mb-0 d-block"><span class="initialism form-error-icon badge badge-danger">Erreur</span><span class="form-error-message">Les mots de passe ne sont pas identiques.</span></span></span>';
                $("#utilisateurs_plainPassword_first").addClass('is-invalid').after(msg);
                disableCreer();
            } else {
                if (password_second && password_first) {
                    $("#utilisateurs_plainPassword_second").parent().find('input, select').removeClass('is-invalid');
                    $("#utilisateurs_plainPassword_second").parent().find(".invalid-feedback").remove();
                    enableCreer();
                }
            }

        });

        $("#utilisateurs_plainPassword_first").keyup(function () {
            $("#utilisateurs_plainPassword_second").parent().find('input, select').removeClass('is-invalid');
            $("#utilisateurs_plainPassword_second").parent().find(".invalid-feedback").remove();
            var password_first = $(this).val();

            var password_second = $("#utilisateurs_plainPassword_second").val();;
            if (password_second && password_first && (password_second != password_first)) {
                var msg = '<span class="invalid-feedback d-block"><span class="mb-0 d-block"><span class="initialism form-error-icon badge badge-danger">Erreur</span><span class="form-error-message">Les mots de passe ne sont pas identiques.</span></span></span>';
                $("#utilisateurs_plainPassword_second").addClass('is-invalid').after(msg);
                disableCreer();
            } else {
                if (password_first && password_second) {
                    $("#utilisateurs_plainPassword_first").parent().find('input, select').removeClass('is-invalid');
                    $("#utilisateurs_plainPassword_first").parent().find(".invalid-feedback").remove();
                    enableCreer();
                }
            }
        });

        // form modif
        $('button[name=modif]').on('click', function (e) {
            $('form[name=form]').submit(function () {
                e.preventDefault();
                $("#form_plainPassword").removeClass('is-invalid');
                $("#regex").remove();
                $("#len").remove();
                var regex = /^(?=.*\d)(?=.*[a-z])(?=.*[A-Z])(?=.*\W)(?!.*\s).*$/;
                var pass = $('#form_plainPassword').val();
                if (pass) {
                    if (!regex.test(pass)) {

                        var msg = '<span id="regex" class="invalid-feedback d-block"><span class="mb-0 d-block"><span class="initialism form-error-icon badge badge-danger">Erreur</span><span class="form-error-message">Doit contenir une majuscule, une minuscule, un chiffre et un symbole.</span></span></span>';
                        $("#form_plainPassword").addClass('is-invalid').after(msg);
                        disableModifier();
                        return false;
                    } else if (pass.length < 8) {

                        var msg = '<span id="len" class="invalid-feedback d-block"><span class="mb-0 d-block"><span class="initialism form-error-icon badge badge-danger">Erreur</span><span class="form-error-message">Doit contenir au moins 8 caractères.</span></span></span>';
                        $("#form_plainPassword").addClass('is-invalid').after(msg);
                        disableModifier();
                        return false;
                    }
                }

                $.ajax({
                    type: "POST",
                    data: {
                        user: $(this).serializeArray()
                    },
                    url: "{{ path('utilisateurs_index_modif_bis') }}",
                    success: function () {
                        $('form[name="form"]')[0].reset();
                        $("#form_roles").trigger('change');
                        $("#grid-data").bootgrid('reload');
                    }
                });
                return false;
            });
        });

        // password_error
        $("#form_plainPassword").keyup(function () {
            $("#form_plainPassword").parent().find('input, select').removeClass('is-invalid');
            $("#form_plainPassword").parent().find(".invalid-feedback").remove();
            enableModifier();
        });

    </script>

{% endblock  %}